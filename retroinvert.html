<!DOCTYPE html>
<html>
<head>
  <title>Retro-Inversion</title>
  <script src="deps/jquery/dist/jquery.js"></script>
  <script src="deps/lodash/dist/lodash.js"></script>
  <script src="deps/machina/lib/machina.js"></script>
  <script src="deps/d3/d3.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cloud.typography.com/7065472/656142/css/fonts.css" />

  <link rel="stylesheet" href="css/iframe.css">
</head>
<body>
  <div class="states">
    <span>
      <a href="#" class="toggle state-change" state="theme">Theme</a><a href="#" class="toggle state-change" state="canon">Canon Solution</a>
    </span>
    <a href="#" class="button " id="play" class="play">Play</a>
  </div>
  <div id="loading">Loading sounds...</div>
  <svg id="interactive"></svg>
  <script type="text/javascript" src="js/core.js"></script>
  <script>
BWV1074.addCanon('retroinvert', [
  ['C', new Voice([
    [C, 5, 0.125], [D, 5, 0.125], [C, 5, 0.75], [A, 4, 0.5], [B, 4, 0.5], [G, 4, 1], [A, 4, 0.5], [F, 4, 1], [B, 4, 1]
    ], 0, null, blue, { reverse : true })],
  ['F', new Voice([
    [F, 4, 0.125], [G, 4, 0.125], [F, 4, 0.75], [D, 4, 0.5], [E, 4, 0.5], [C, 4, 1], [D, 4, 0.5], [B, 3, 1], [E, 4, 1]
    ], 0.5, null, red, { reverse : true })],
  ['D', new Voice([
    [D, 4, 0.125], [E, 4, 0.125], [D, 4, 0.75], [B, 3, 0.5], [C, 4, 0.5], [A, 3, 1], [B, 3, 0.5], [G, 3, 1], [B, 3, 1]
    ], 1, null, yellow, { reverse : true })],
  ['G', new Voice([
    [G, 3, 0.125], [A, 3, 0.125], [G, 3, 0.75], [E, 3, 0.5], [F, 3, 0.5], [D, 3, 1], [E, 3, 0.5], [C, 3, 1], [F, 3, 1]
    ], 1.5, null, green, { reverse : true })]
]);


var stateMachine = new machina.Fsm({
  initialize : function() {
    var self = this;
    var playButton = document.getElementById('play');
    playButton.addEventListener('click', function(evt) {
      evt.preventDefault();
      self.handle('play');
    });
    $('.states').on('click', '.state-change', function(evt) {
      evt.preventDefault();
      self.transition(this.getAttribute('state'));
      return false;
    });
  },
  initialState : 'loading',
  states : {
    'loading' : {
      _onEnter : function() {
        var self = this;
        Note.prototype.when.then(function() {
          // I don't know why we need this, but it seems to be helpful
          setTimeout(function() {
            self.transition('theme')
          }, 500);
        });
      },
      _onExit : function() {
        document.getElementById('loading').remove();
      }
    },
    'theme' : {
      _onEnter : function() {
        console.log('switching to theme');
        $('.state-change').removeClass('selected')
          .filter('[state=theme]').addClass('selected');
        updateDisplay();
      },
      play : function() {
        BWV1074.play();
      }
    },
    'canon' : {
      _onEnter : function() {
        $('.state-change').removeClass('selected')
          .filter('[state=canon]').addClass('selected');
        updateDisplay('retroinvert');
      },
      play : function() {
        BWV1074.play('retroinvert', 3);
      }
    }
  }
});

  </script>
</body>
</html>
